import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Send, Trophy, Lock, Eye, HelpCircle, Sun, Moon, Timer, Crown, Flame, Shield, Star } from 'lucide-react';

// --- PUZZLE DATABASE: 30 DAYS ---
const PUZZLE_BANK = [
  [{category: "DOCUMENT", word: "PASSPORT"}, {category: "WEAPON", word: "TORPEDO"}, {category: "SANCTUARY", word: "OASIS"}, {category: "STORAGE", word: "SAFE"}, {category: "PENALTY", word: "EXILE"}],
  [{category: "CRIME", word: "FORGERY"}, {category: "VESSEL", word: "YACHT"}, {category: "DISGUISE", word: "TOUPEE"}, {category: "ILLUSION", word: "ECHO"}, {category: "BARRIER", word: "OCEAN"}],
  [{category: "VICE", word: "GOSSIP"}, {category: "STORAGE", word: "POCKET"}, {category: "CONFLICT", word: "TREATY"}, {category: "CURRENCY", word: "YEN"}, {category: "REMEDY", word: "NAP"}],
  [{category: "WEAPON", word: "POISON"}, {category: "BODY", word: "NOSE"}, {category: "STORAGE", word: "ENVELOPE"}, {category: "CRIME", word: "EXTORT"}, {category: "BARRIER", word: "TRENCH"}],
  [{category: "SANCTUARY", word: "PRISON"}, {category: "REMEDY", word: "NEEDLE"}, {category: "PENALTY", word: "EVICTION"}, {category: "DOCUMENT", word: "NOTICE"}, {category: "DISGUISE", word: "EYEPATCH"}],
  [{category: "ILLUSION", word: "MIRAGE"}, {category: "BODY", word: "EYE"}, {category: "VESSEL", word: "ENGINE"}, {category: "PENALTY", word: "EXAM"}, {category: "DISGUISE", word: "MASK"}],
  [{category: "CRIME", word: "THEFT"}, {category: "BODY", word: "TEAR"}, {category: "EMOTION", word: "RAGE"}, {category: "PENALTY", word: "EXILE"}, {category: "SANCTUARY", word: "ESTATE"}],
  [{category: "VICE", word: "RUMOR"}, {category: "BARRIER", word: "ROOF"}, {category: "CRIME", word: "FRAUD"}, {category: "PENALTY", word: "DEBT"}, {category: "SANCTUARY", word: "TENT"}],
  [{category: "DISGUISE", word: "ALIAS"}, {category: "BODY", word: "SCAR"}, {category: "DOCUMENT", word: "RECEIPT"}, {category: "CONCEPT", word: "TRUTH"}, {category: "SANCTUARY", word: "HAVEN"}],
  [{category: "PENALTY", word: "RANSOM"}, {category: "REMEDY", word: "MEDICINE"}, {category: "VICE", word: "ENVY"}, {category: "BARRIER", word: "YARD"}, {category: "DOCUMENT", word: "DEED"}],
  [{category: "VICE", word: "GREED"}, {category: "CURRENCY", word: "DOLLAR"}, {category: "BODY", word: "RIB"}, {category: "CRIME", word: "BRIBERY"}, {category: "REMEDY", word: "YAWN"}],
  [{category: "CONFLICT", word: "STRIKE"}, {category: "VICE", word: "EGO"}, {category: "STORAGE", word: "OVEN"}, {category: "DISGUISE", word: "NINJA"}, {category: "PENALTY", word: "ARREST"}],
  [{category: "VICE", word: "SLOTH"}, {category: "BODY", word: "HEART"}, {category: "VESSEL", word: "TANK"}, {category: "WEAPON", word: "KNIFE"}, {category: "CONFLICT", word: "ENEMY"}],
  [{category: "DOCUMENT", word: "LEASE"}, {category: "SANCTUARY", word: "ESTATE"}, {category: "CRIME", word: "EXTORT"}, {category: "BARRIER", word: "TRENCH"}, {category: "SANCTUARY", word: "HOTEL"}],
  [{category: "ILLUSION", word: "GHOST"}, {category: "DOCUMENT", word: "TREATY"}, {category: "VESSEL", word: "YACHT"}, {category: "SANCTUARY", word: "TENT"}, {category: "BARRIER", word: "TRENCH"}],
  [{category: "VICE", word: "PRIDE"}, {category: "WEAPON", word: "EXPLOSIVE"}, {category: "BODY", word: "EYE"}, {category: "DOCUMENT", word: "EDICT"}, {category: "STORAGE", word: "TOMB"}],
  [{category: "DISGUISE", word: "SPY"}, {category: "VICE", word: "YEARNING"}, {category: "BARRIER", word: "GATE"}, {category: "DOCUMENT", word: "EMAIL"}, {category: "STORAGE", word: "LOCK"}],
  [{category: "CRIME", word: "HEIST"}, {category: "VESSEL", word: "TANKER"}, {category: "BARRIER", word: "ROOF"}, {category: "DOCUMENT", word: "FILE"}, {category: "PENALTY", word: "EXILE"}],
  [{category: "ILLUSION", word: "MYTH"}, {category: "WEAPON", word: "HARPOON"}, {category: "PENALTY", word: "NOOSE"}, {category: "SANCTUARY", word: "ESTATE"}, {category: "WEAPON", word: "EXPLOSIVE"}],
  [{category: "CONFLICT", word: "REBEL"}, {category: "SANCTUARY", word: "LAIR"}, {category: "CURRENCY", word: "RANSOM"}, {category: "STORAGE", word: "MIND"}, {category: "WEAPON", word: "DAGGER"}],
  [{category: "BARRIER", word: "MOAT"}, {category: "WEAPON", word: "TEETH"}, {category: "PENALTY", word: "HOSTAGE"}, {category: "DOCUMENT", word: "EDICT"}, {category: "SANCTUARY", word: "TOWER"}],
  [{category: "CURRENCY", word: "CASH"}, {category: "ANIMAL", word: "HORSE"}, {category: "PENALTY", word: "EXILE"}, {category: "BODY", word: "EYE"}, {category: "REMEDY", word: "ELIXIR"}],
  [{category: "ILLUSION", word: "DREAM"}, {category: "BODY", word: "MUSCLE"}, {category: "NATURE", word: "EROSION"}, {category: "PENALTY", word: "NOOSE"}, {category: "PENALTY", word: "EXILE"}],
  [{category: "STORAGE", word: "CARGO"}, {category: "DOCUMENT", word: "OATH"}, {category: "SANCTUARY", word: "HARBOR"}, {category: "CONFLICT", word: "RIOT"}, {category: "CRIME", word: "THEFT"}],
  [{category: "WEAPON", word: "PISTOL"}, {category: "DOCUMENT", word: "LEDGER"}, {category: "EMOTION", word: "REGRET"}, {category: "BODY", word: "TEAR"}, {category: "SANCTUARY", word: "RESORT"}],
  [{category: "DOCUMENT", word: "MAP"}, {category: "CURRENCY", word: "PESO"}, {category: "PENALTY", word: "OUTCAST"}, {category: "BODY", word: "TOOTH"}, {category: "CRIME", word: "HEIST"}],
  [{category: "STORAGE", word: "VAULT"}, {category: "CURRENCY", word: "TOKEN"}, {category: "DOCUMENT", word: "NOVEL"}, {category: "SANCTUARY", word: "LODGE"}, {category: "VESSEL", word: "ENGINE"}],
  [{category: "CONFLICT", word: "DUEL"}, {category: "WEAPON", word: "LANCE"}, {category: "DISGUISE", word: "EYEPATCH"}, {category: "BARRIER", word: "HEDGE"}, {category: "DOCUMENT", word: "EMAIL"}],
  [{category: "DISGUISE", word: "ALIAS"}, {category: "ILLUSION", word: "SHADOW"}, {category: "PENALTY", word: "WOUND"}, {category: "DOCUMENT", word: "DECREE"}, {category: "SANCTUARY", word: "ESTATE"}],
  [{category: "CRIME", word: "CARTEL"}, {category: "BODY", word: "LUNG"}, {category: "VICE", word: "GOSSIP"}, {category: "BARRIER", word: "PICKET"}, {category: "CURRENCY", word: "TOKEN"}]
];

// --- MASTER CONFIG & GAME LOGIC ---
const GRID_WIDTH = 8;
const CHECK_PENALTY = 15;
const HINT_PENALTIES = [15, 20, 30];
const CELL_SIZE = 38; 
const GAP_X = 5;      
const GAP_Y = 22; 

// Dynamic puzzle builder 
const buildPuzzle = (wordList, puzzleNumber) => {
  let solution = wordList[0].word;
  let hingeIndices = [];
  let words = [{ category: wordList[0].category }];

  for (let i = 1; i < wordList.length; i++) {
      const currentWord = wordList[i].word;
      words.push({ category: wordList[i].category });
      hingeIndices.push(solution.length - 1);
      solution += currentWord.slice(1);
  }

  return { solution, words, hingeIndices, anchors: [0, solution.length - 1], puzzleNumber };
};

// Calculate Local Time Day ID (Avoids Timezone bugs)
const getLocalDayDiff = () => {
  const now = new Date();
  const localEpoch = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
  const gameEpoch = Date.UTC(2026, 1, 27); // Launch Date: Feb 27, 2026 (Month is 0-indexed)
  let dayDiff = Math.floor((localEpoch - gameEpoch) / (1000 * 60 * 60 * 24));
  return dayDiff >= 0 ? dayDiff : 0;
};

// ADDED +1 HERE FOR TESTING PURPOSES
const dayDiff = getLocalDayDiff() + 1;
const puzzleIndex = dayDiff % PUZZLE_BANK.length;
const DAILY_CONFIG = buildPuzzle(PUZZLE_BANK[puzzleIndex], dayDiff + 1);
const SOLUTION_STR = DAILY_CONFIG.solution;

// Metagame Logic: Ranks
const getRankInfo = (xp) => {
    const ranks = [
        { name: "Novice", xp: 0 },
        { name: "Wanderer", xp: 2000 },
        { name: "Tracker", xp: 7000 },
        { name: "Explorer", xp: 15000 },
        { name: "Pathfinder", xp: 30000 },
        { name: "Trailblazer", xp: 50000 },
        { name: "Grandmaster", xp: 100000 }
    ];
    let currentRank = ranks[0];
    let nextRank = ranks[1];
    for (let i = 0; i < ranks.length; i++) {
        if (xp >= ranks[i].xp) {
            currentRank = ranks[i];
            nextRank = ranks[i+1] || ranks[i];
        }
    }
    const progress = nextRank.xp === currentRank.xp ? 100 : ((xp - currentRank.xp) / (nextRank.xp - currentRank.xp)) * 100;
    return { currentRank, nextRank, progress };
};

const App = () => {
  const [grid, setGrid] = useState([]);
  const [bank, setBank] = useState([]);
  const [selectedBankIdx, setSelectedBankIdx] = useState(null);
  const [isGameOver, setIsGameOver] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [personalMessage, setPersonalMessage] = useState("");
  const [selectedEmoji, setSelectedEmoji] = useState("ðŸ‘‹");
  const [showValidation, setShowValidation] = useState(false);
  const [darkMode, setDarkMode] = useState(true);
  const [isPB, setIsPB] = useState(false);
  const [hintedIndices, setHintedIndices] = useState([]);
  
  // Metagame States
  const [sessionXP, setSessionXP] = useState(0);
  const [userStats, setUserStats] = useState({ totalXP: 0, currentStreak: 0, maxStreak: 0, lastPlayedDayId: -1 });

  const [seconds, setSeconds] = useState(0);
  const [displaySeconds, setDisplaySeconds] = useState(0); // Animation state for time
  const [barWidth, setBarWidth] = useState(0); // Animation state for progress bar
  const [isActive, setIsActive] = useState(false);
  const [checkCount, setCheckCount] = useState(0);
  const [hintCount, setHintCount] = useState(0);
  const timerRef = useRef(null);

  const pathNodes = useMemo(() => {
    let nodes = [];
    let r = 0, c = 0, dir = 1; 
    for (let i = 0; i < SOLUTION_STR.length; i++) {
      nodes.push({ r, c, index: i });
      if (dir === 1) {
        if (c < GRID_WIDTH - 1) c++;
        else { r++; dir = -1; }
      } else {
        if (c > 0) c--;
        else { r++; dir = 1; }
      }
    }
    return nodes;
  }, []);

  const svgPathD = useMemo(() => {
    return pathNodes.reduce((acc, node, i) => {
      const x = node.c * (CELL_SIZE + GAP_X) + CELL_SIZE / 2;
      const y = node.r * (CELL_SIZE + GAP_Y) + CELL_SIZE / 2;
      return acc + (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
    }, "");
  }, [pathNodes]);

  useEffect(() => {
    if (isActive && !isGameOver) {
      timerRef.current = setInterval(() => setSeconds(s => s + 1), 1000);
    } else {
      clearInterval(timerRef.current);
    }
    return () => clearInterval(timerRef.current);
  }, [isActive, isGameOver]);

  // --- ANIMATION EFFECTS FOR SHARE MODAL ---
  useEffect(() => {
    if (showShareModal) {
        // 1. Progress Bar Animation (delay ensures CSS transition triggers after modal mounts)
        const timeoutId = setTimeout(() => {
            setBarWidth(getRankInfo(userStats.totalXP).progress);
        }, 300);

        // 2. Time Taken "Scroll" Animation (Easing function)
        let startTimestamp = null;
        const duration = 1500; // 1.5 seconds
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            // Cubic easing out for a fast start and satisfying slow finish
            const easeOutCubic = 1 - Math.pow(1 - progress, 3);
            
            setDisplaySeconds(Math.floor(easeOutCubic * seconds));
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);

        return () => clearTimeout(timeoutId);
    } else {
        // Reset states when modal is closed
        setBarWidth(0);
        setDisplaySeconds(0);
    }
  }, [showShareModal, seconds, userStats.totalXP]);

  const formatTime = (t) => {
    const m = Math.floor(t / 60);
    const s = t % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
  };

  useEffect(() => {
    const initialGrid = SOLUTION_STR.split("").map((char, i) => {
      if (DAILY_CONFIG.anchors.includes(i)) return char;
      return null;
    });
    setGrid(initialGrid);
    
    const interiorLetters = SOLUTION_STR.split("").filter((_, i) => 
      !DAILY_CONFIG.anchors.includes(i)
    );
    setBank(interiorLetters.sort(() => Math.random() - 0.5).map((char, id) => ({ char, id, used: false })));
  }, []);

  const handleBankClick = (idx) => {
    if (isGameOver || bank[idx].used) return;
    setSelectedBankIdx(idx === selectedBankIdx ? null : idx);
  };

  const handleGridClick = (idx) => {
    if (isGameOver || DAILY_CONFIG.anchors.includes(idx)) return;
    if (!isActive) setIsActive(true);
    const newGrid = [...grid];
    const newBank = [...bank];
    if (selectedBankIdx !== null && newGrid[idx] === null) {
      newGrid[idx] = newBank[selectedBankIdx].char;
      newBank[selectedBankIdx].used = true;
      setGrid(newGrid);
      setBank(newBank);
      setSelectedBankIdx(null);
      setShowValidation(false); 
    } else if (newGrid[idx] !== null) {
      const charToRemove = newGrid[idx];
      const bankItem = newBank.find(b => b.char === charToRemove && b.used);
      if (bankItem) bankItem.used = false;
      newGrid[idx] = null;
      setGrid(newGrid);
      setBank(newBank);
      setShowValidation(false);
      setHintedIndices(prev => prev.filter(i => i !== idx));
    }
  };

  const handleCheck = () => {
    if (isGameOver) return;
    setCheckCount(c => c + 1);
    setSeconds(s => s + CHECK_PENALTY);
    setShowValidation(true);
  };

  const handleHint = () => {
    if (isGameOver || hintCount >= 3) return;
    
    // Dynamically check ALL non-anchor spaces from start to finish
    const hintTargetIndices = Array.from({ length: SOLUTION_STR.length }, (_, i) => i)
        .filter(i => !DAILY_CONFIG.anchors.includes(i));
        
    // Find the very first space that is empty or incorrect
    const hintIdx = hintTargetIndices.find(i => grid[i] !== SOLUTION_STR[i]);
    
    if (hintIdx !== undefined) {
      const charToReveal = SOLUTION_STR[hintIdx];
      const penalty = HINT_PENALTIES[hintCount];
      const newGrid = [...grid];
      const newBank = [...bank];

      if (newGrid[hintIdx] !== null) {
        const wrongChar = newGrid[hintIdx];
        const returnIdx = newBank.findIndex(item => item.char === wrongChar && item.used);
        if (returnIdx !== -1) newBank[returnIdx].used = false;
      }

      const bankItemIdx = newBank.findIndex(item => item.char === charToReveal && !item.used);
      if (bankItemIdx !== -1) {
        newBank[bankItemIdx].used = true;
        newGrid[hintIdx] = charToReveal;
        setGrid(newGrid);
        setBank(newBank);
        setSeconds(s => s + penalty);
        setHintCount(prev => prev + 1);
        setHintedIndices(prev => [...prev, hintIdx]);
        if (!isActive) setIsActive(true);
      }
    }
  };

  const handleFinishGame = () => {
    if (!isComplete) return;
    
    // Check against saved Personal Best in localStorage
    const savedPB = localStorage.getItem('trails_pb');
    if (!savedPB || seconds < parseInt(savedPB, 10)) {
        localStorage.setItem('trails_pb', seconds.toString());
        setIsPB(true);
    } else {
        setIsPB(false);
    }

    // --- NEW METAGAME LOGIC ---
    const savedData = localStorage.getItem('trails_save');
    const stats = savedData ? JSON.parse(savedData) : { totalXP: 0, currentStreak: 0, maxStreak: 0, lastPlayedDayId: -1 };
    
    let earnedXP = 0;
    let newStreak = stats.currentStreak;

    // Prevent infinite XP farming on the same daily puzzle
    if (stats.lastPlayedDayId !== dayDiff) {
        const baseXP = 500;
        const speedBonus = Math.max(0, Math.floor(300 * (1 - seconds / 300))); // decays over 5 mins
        const flawlessBonus = (checkCount === 0 && hintCount === 0) ? 200 : 0;
        const penalties = (checkCount * 50) + (hintCount * 100);
        
        earnedXP = Math.max(100, baseXP + speedBonus + flawlessBonus - penalties);

        if (stats.lastPlayedDayId === dayDiff - 1) {
            newStreak += 1;
        } else {
            newStreak = 1;
        }

        stats.totalXP += earnedXP;
        stats.currentStreak = newStreak;
        stats.maxStreak = Math.max(stats.maxStreak, newStreak);
        stats.lastPlayedDayId = dayDiff;
        
        localStorage.setItem('trails_save', JSON.stringify(stats));
    } else {
        // They already played today, just load their data
        earnedXP = 0;
    }

    setSessionXP(earnedXP);
    setUserStats(stats);
    // --- END METAGAME LOGIC ---

    setIsGameOver(true);
    setShowShareModal(true);
  };

  const isComplete = grid.every(char => char !== null);
  const score = grid.filter((char, i) => char === SOLUTION_STR[i]).length;

  const copyToClipboard = () => {
    // Format the emojis into a true 8-column grid layout
    const visualRows = [];
    for (let i = 0; i < SOLUTION_STR.length; i += GRID_WIDTH) {
      const rowChars = [];
      for (let j = 0; j < GRID_WIDTH; j++) {
        const idx = i + j;
        if (idx < SOLUTION_STR.length) {
          if (DAILY_CONFIG.anchors.includes(idx)) rowChars.push("ðŸŸ¦");
          else if (hintedIndices.includes(idx)) rowChars.push("ðŸŸ§");
          else rowChars.push(grid[idx] === SOLUTION_STR[idx] ? "ðŸŸ©" : "â¬œ");
        }
      }
      visualRows.push(rowChars.join(""));
    }
    const visual = visualRows.join("\n");

    // Clean, compact text formatting with Metagame stats
    const rankInfo = getRankInfo(userStats.totalXP);
    const pbText = isPB ? " ðŸ‘‘ PB!" : "";
    const msgText = personalMessage.trim() ? `${selectedEmoji} ${personalMessage}\n` : "";
    
    let statsHeader = `TRAILS #${DAILY_CONFIG.puzzleNumber}`;
    if (userStats.currentStreak > 0) {
        statsHeader += `\nðŸ”¥ ${userStats.currentStreak} Day Streak | ðŸ›¡ï¸ Rank: ${rankInfo.currentRank.name}`;
    }
    if (sessionXP > 0) {
        statsHeader += `\nâœ¨ +${sessionXP} XP`;
    }

    const text = `${statsHeader}\n${msgText}\nâ± ${formatTime(seconds)}${pbText} | ðŸ” ${checkCount} | ðŸ’¡ ${hintCount} | âœ… ${score}/${SOLUTION_STR.length}\n\n${visual}\n\nhttps://planomy.github.io/trails`;
    
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);

    const btn = document.getElementById('share-btn');
    if (btn) btn.innerText = "COPIED TO CLIPBOARD!";
    setTimeout(() => { if (btn) btn.innerText = "SHARE YOUR RESULTS"; }, 2000);
  };

  const rowCount = Math.ceil(SOLUTION_STR.length / GRID_WIDTH);
  const rowsArray = Array.from({ length: rowCount }, (_, i) => i);

  return (
    <div className={`min-h-screen transition-colors duration-500 font-sans p-4 pb-4 flex flex-col items-center justify-center select-none overflow-x-hidden ${darkMode ? 'bg-[#020617] text-slate-200' : 'bg-[#F8FAFC] text-slate-800'}`}>
      
      <header className="w-full max-w-[340px] flex justify-between items-center mb-4 mt-2">
        <h1 className="text-3xl font-black tracking-tighter text-orange-500 italic leading-none filter drop-shadow-sm">TRAILS</h1>
        <div className="flex items-center gap-2">
            <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-2xl border-2 transition-all active:scale-90 ${darkMode ? 'border-slate-800 bg-slate-900 text-orange-400' : 'border-slate-200 bg-white text-slate-400'}`}>
                {darkMode ? <Sun size={20} strokeWidth={2.5} /> : <Moon size={20} strokeWidth={2.5} />}
            </button>
            <div className={`${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} px-2.5 py-1.5 rounded-2xl shadow-sm border-2 flex items-center gap-2 min-w-[90px] justify-center`}>
                <Timer size={18} stroke="#F97316" strokeWidth={2.5} />
                <div className={`text-xl font-black font-mono tracking-tighter ${darkMode ? 'text-orange-400' : 'text-slate-700'}`}>
                    {formatTime(seconds)}
                </div>
            </div>
        </div>
      </header>

      <div className={`w-full max-w-[340px] p-2 rounded-xl shadow-sm border mb-4 transition-colors ${darkMode ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-slate-200'}`}>
        <div className="flex flex-wrap gap-1.5 justify-center">
            {DAILY_CONFIG.words.map((w, i) => (
                <span key={i} className={`px-2 py-0.5 rounded-lg text-[9px] font-bold border uppercase italic tracking-wider transition-colors ${darkMode ? 'bg-slate-800 text-slate-400 border-slate-700' : 'bg-slate-50 text-slate-500 border-slate-100'}`}>
                    {w.category}
                </span>
            ))}
        </div>
      </div>

      <div className="flex flex-col items-center w-full relative z-10">
        <div 
            className="relative"
            style={{ width: GRID_WIDTH * CELL_SIZE + (GRID_WIDTH - 1) * GAP_X }}
        >
            <svg className="absolute inset-0 z-0 pointer-events-none overflow-visible w-full h-full">
                <path 
                    d={svgPathD}
                    fill="transparent" 
                    stroke="#F97316" 
                    strokeWidth="3.5" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                    className={darkMode ? "opacity-80" : "opacity-40"}
                />
            </svg>

            <div className="relative z-10 flex flex-col w-full h-full" style={{ gap: GAP_Y }}>
                {rowsArray.map(rIdx => (
                    <div key={rIdx} className="flex" style={{ gap: GAP_X }}>
                        {Array.from({ length: 8 }).map((_, cIdx) => {
                            const node = pathNodes.find(n => n.r === rIdx && n.c === cIdx);
                            if (!node) return <div key={cIdx} style={{ width: CELL_SIZE, height: CELL_SIZE }} />;

                            const idx = node.index;
                            const char = grid[idx];
                            const isAnchor = DAILY_CONFIG.anchors.includes(idx);
                            const isHinge = DAILY_CONFIG.hingeIndices.includes(idx);
                            const isCorrect = char === SOLUTION_STR[idx];
                            const isHinted = hintedIndices.includes(idx);

                            return (
                                <button
                                    key={cIdx}
                                    onClick={() => handleGridClick(idx)}
                                    style={{ width: CELL_SIZE, height: CELL_SIZE }}
                                    className={`
                                        flex items-center justify-center text-xl font-black rounded-xl
                                        transition-all duration-300 transform relative active:scale-90
                                        ${isAnchor ? 'bg-blue-600 text-white shadow-lg border-0' : 
                                            isHinted ? 'bg-amber-500 text-white border-0 shadow-md' :
                                            (showValidation || isGameOver) && isCorrect ? 'bg-emerald-600 text-white scale-105 border-0 shadow-md' :
                                            (showValidation || isGameOver) && !isCorrect && char ? 'bg-rose-600 text-white border-0 shadow-md' :
                                            isHinge && !char ? (darkMode ? 'bg-slate-700 border-[3px] border-white shadow-inner' : 'bg-slate-200 border-[3px] border-slate-900 shadow-inner') :
                                            isHinge && char ? (darkMode ? 'bg-slate-800 text-indigo-400 border-[3px] border-white shadow-xl' : 'bg-white border-[3px] border-slate-900 text-indigo-700 shadow-md') :
                                            char ? (darkMode ? 'bg-slate-800 text-indigo-400 border-2 border-slate-600 shadow-xl' : 'bg-white border-2 border-slate-300 text-indigo-700 shadow-sm') :
                                            (darkMode ? 'bg-[#0f172a] border-2 border-slate-600 text-slate-700' : 'bg-white border-2 border-slate-300 text-slate-200')}
                                    `}
                                >
                                    {char}
                                    {isAnchor && <div className="absolute top-0.5 left-0.5 opacity-40"><Lock size={10} strokeWidth={3} /></div>}
                                </button>
                            );
                        })}
                    </div>
                ))}
            </div>
        </div>
      </div>

      {!isGameOver && (
        <div className={`w-full max-w-[340px] p-3 rounded-[2rem] shadow-2xl border-b-6 transition-all mt-8 mb-2 relative z-30 ${darkMode ? 'bg-slate-900 border-slate-950' : 'bg-white border-slate-200'}`}>
            <div className="grid grid-cols-7 gap-1.5 mb-2">
                {bank.map((item, i) => (
                    <button
                        key={item.id}
                        disabled={item.used}
                        onClick={() => handleBankClick(i)}
                        className={`
                            aspect-square flex items-center justify-center rounded-xl font-black text-xl transition-all active:scale-90
                            ${item.used ? 'scale-0 opacity-0 pointer-events-none' : 
                                selectedBankIdx === i ? 'bg-indigo-600 text-white ring-4 ring-indigo-500/30 scale-110 z-20 shadow-xl' : 
                                (darkMode ? 'bg-slate-800 text-indigo-400 border-2 border-slate-700 hover:bg-slate-700' : 'bg-indigo-50 text-indigo-700 border-2 border-indigo-100 hover:bg-indigo-100')}
                        `}
                    >
                        {item.char}
                    </button>
                ))}
            </div>

            <button 
                onClick={handleFinishGame}
                className={`w-full font-black py-3.5 rounded-2xl text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2
                    ${isComplete ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-600/30' : (darkMode ? 'bg-slate-800 text-slate-700' : 'bg-slate-200 text-slate-400') + ' pointer-events-none'}
                `}
            >
                <Send size={18} strokeWidth={2.5} /> LOCK & MAIL
            </button>
        </div>
      )}

      <div className="w-full flex justify-center gap-3 mt-4 mb-2 relative z-20">
          <button 
              onClick={handleHint}
              disabled={hintCount >= 3}
              className={`flex items-center gap-1.5 p-1 px-2.5 rounded-full border shadow-sm transition-all active:scale-95 ${hintCount >= 3 ? 'opacity-30 cursor-not-allowed' : (darkMode ? 'bg-slate-900 border-slate-800 text-slate-400 hover:text-orange-400' : 'bg-white border-slate-200 text-slate-500 hover:text-indigo-600')}`}
          >
              <div className="flex items-center gap-1.5 font-bold uppercase tracking-wider text-[10px]">
                  <HelpCircle size={16} strokeWidth={2.5} /> HINT
              </div>
              <div className="flex gap-1 ml-1">
                  {HINT_PENALTIES.map((penalty, i) => (
                      <div 
                          key={i} 
                          className={`w-7 h-5 flex items-center justify-center text-[8px] font-black rounded-md transition-colors border
                              ${i < hintCount 
                                  ? 'bg-rose-600 border-rose-700 text-white' 
                                  : (darkMode ? 'bg-slate-800 border-slate-700 text-slate-500' : 'bg-slate-50 border-slate-200 text-slate-400')}
                          `}
                      >
                          +{penalty}
                      </div>
                  ))}
              </div>
          </button>

          <button 
              onClick={handleCheck}
              className={`flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider transition-all py-2.5 px-6 rounded-full border shadow-sm active:scale-95 ${darkMode ? 'bg-slate-900 text-slate-400 border-slate-800 hover:text-orange-400' : 'bg-white text-slate-500 border-slate-200 hover:text-indigo-600'}`}
          >
              <Eye size={16} strokeWidth={2.5} /> CHECK <span className="opacity-50 ml-0.5">+15s</span>
          </button>
      </div>

      {showShareModal && (
        <div className="fixed inset-0 bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-4 z-50 animate-in fade-in duration-300">
            <div className={`${darkMode ? 'bg-[#0f172a] border border-slate-800' : 'bg-white'} w-full max-w-[340px] max-h-[95vh] rounded-[2.5rem] flex flex-col shadow-2xl animate-in zoom-in duration-300`}>
                <div className="bg-gradient-to-br from-indigo-600 to-indigo-800 p-6 text-white text-center relative shrink-0 rounded-t-[2.5rem]">
                    <Trophy className="mx-auto" size={40} strokeWidth={2} />
                    <h2 className="text-2xl font-black tracking-tight uppercase italic leading-none mt-3">Trail Solved!</h2>
                </div>
                
                <div className="p-6 space-y-4 overflow-y-auto custom-scrollbar">
                    {/* NEW PROGRESSION UI */}
                    <div className={`p-4 rounded-3xl border-2 ${darkMode ? 'border-slate-800 bg-slate-900/80' : 'border-indigo-100 bg-indigo-50/80'}`}>
                        <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-1.5 text-orange-500 font-black text-[11px] uppercase tracking-wider">
                                <Flame size={14} strokeWidth={3} /> {userStats.currentStreak > 0 ? `${userStats.currentStreak} Day Streak` : 'No Streak'}
                            </div>
                            <div className="flex items-center gap-1.5 text-indigo-500 font-black text-[11px] uppercase tracking-wider">
                                <Shield size={14} strokeWidth={3} /> {getRankInfo(userStats.totalXP).currentRank.name}
                            </div>
                        </div>
                        <div className={`w-full rounded-full h-2.5 mb-2 overflow-hidden ${darkMode ? 'bg-slate-950' : 'bg-white'}`}>
                            <div className="bg-gradient-to-r from-indigo-500 to-orange-500 h-full rounded-full transition-all duration-1000 ease-out" style={{width: `${barWidth}%`}}></div>
                        </div>
                        <div className="flex justify-between text-[9px] text-slate-500 font-black tracking-widest uppercase">
                            <span>{userStats.totalXP.toLocaleString()} XP</span>
                            <span>{getRankInfo(userStats.totalXP).nextRank.name} ({getRankInfo(userStats.totalXP).nextRank.xp.toLocaleString()})</span>
                        </div>
                        {sessionXP > 0 && (
                            <div className="text-center mt-3 text-xs font-black text-emerald-500 animate-pulse bg-emerald-500/10 py-1.5 rounded-lg flex items-center justify-center gap-1">
                                <Star size={14} /> +{sessionXP} XP EARNED TODAY!
                            </div>
                        )}
                        {sessionXP === 0 && userStats.lastPlayedDayId === dayDiff && (
                             <div className="text-center mt-3 text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                                XP Already claimed today
                             </div>
                        )}
                    </div>
                    {/* END PROGRESSION UI */}

                    <div className="grid grid-cols-2 gap-3">
                            <div className={`p-3 rounded-2xl border-2 text-center relative ${darkMode ? 'border-slate-800 bg-slate-900/50' : 'border-slate-100 bg-slate-50'}`}>
                                    {isPB && (
                                        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-amber-300 to-amber-500 text-amber-950 text-[9px] font-black px-3 py-0.5 rounded-full uppercase tracking-widest shadow-md flex items-center gap-1 whitespace-nowrap">
                                            <Crown size={10} strokeWidth={3} /> NEW PB
                                        </div>
                                    )}
                                    <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">FINAL TIME</p>
                                    <p className="text-xl font-black text-orange-500">{formatTime(displaySeconds)}</p>
                            </div>
                            <div className={`p-3 rounded-2xl border-2 text-center ${darkMode ? 'border-slate-800 bg-slate-900/50' : 'border-slate-100 bg-slate-50'}`}>
                                    <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest">CHECKS</p>
                                    <p className="text-xl font-black text-orange-500">{checkCount}</p>
                            </div>
                    </div>

                    <textarea 
                        placeholder="Type a personal message..."
                        value={personalMessage}
                        onChange={(e) => setPersonalMessage(e.target.value)}
                        className={`w-full p-3 border-2 rounded-2xl font-bold outline-none h-20 resize-none text-sm shadow-inner transition-colors ${darkMode ? 'bg-slate-950 border-slate-800 text-white focus:border-indigo-500' : 'bg-slate-50 border-slate-100 text-slate-900 focus:border-indigo-500'}`}
                    />

                    <div className={`flex justify-between p-1.5 rounded-2xl border ${darkMode ? 'bg-slate-950 border-slate-800' : 'bg-indigo-50 border-indigo-100'}`}>
                        {["ðŸ‘‹", "ðŸ”¥", "ðŸ¤”", "ðŸ’ª", "ðŸ†"].map(e => (
                            <button key={e} onClick={() => setSelectedEmoji(e)} className={`text-xl p-2 rounded-xl transition-all ${selectedEmoji === e ? (darkMode ? 'bg-slate-800 shadow-md' : 'bg-white shadow-md') + ' scale-125' : 'opacity-30 hover:opacity-100'}`}>{e}</button>
                        ))}
                    </div>

                    <button id="share-btn" onClick={copyToClipboard} className="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all shadow-indigo-600/30">
                        <Send size={18} strokeWidth={2.5} /> SHARE YOUR RESULTS
                    </button>
                    <button onClick={() => setShowShareModal(false)} className="w-full text-slate-500 font-bold py-1 text-xs uppercase tracking-[0.2em] text-center shrink-0">Back to Grid</button>
                </div>
            </div>
        </div>
      )}
    </div>
  );
};

export default App;
